<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:MoneyMindApp.ViewModels"
             xmlns:models="clr-namespace:MoneyMindApp.Models"
             xmlns:converters="clr-namespace:MoneyMindApp.Converters"
             xmlns:System="clr-namespace:System;assembly=netstandard"
             x:Class="MoneyMindApp.Views.MainPage"
             x:DataType="vm:MainViewModel"
             Title="Dashboard"
             BackgroundColor="{AppThemeBinding Light={StaticResource BackgroundLight}, Dark={StaticResource BackgroundDark}}">

    <Grid>
        <!-- Main Content with Gradient Background -->
        <RefreshView Command="{Binding RefreshCommand}"
                     IsRefreshing="{Binding IsLoading}"
                     RefreshColor="{StaticResource Primary}">
            <ScrollView>
                <VerticalStackLayout Spacing="20" Padding="16,20">

                    <!-- Header Section (Clean & Minimal) -->
                    <VerticalStackLayout Spacing="8" Margin="0,0,0,8">
                        <!-- Account Name (Primary) -->
                        <Label Text="{Binding CurrentAccount.Nome}"
                               Style="{StaticResource HeadlineLarge}"
                               TextColor="{AppThemeBinding Light={StaticResource OnSurface}, Dark={StaticResource TextPrimaryDark}}"
                               LineBreakMode="TailTruncation"
                               MaxLines="2"
                               HorizontalOptions="Fill"
                               IsVisible="{Binding CurrentAccount, Converter={StaticResource IsNotNullConverter}}" />

                        <!-- Current Date (Subtle) -->
                        <Label Text="{Binding Source={x:Static System:DateTime.Now}, StringFormat='{0:dddd, dd MMMM yyyy}'}"
                               Style="{StaticResource BodyMedium}"
                               TextColor="{AppThemeBinding Light={StaticResource OnSurfaceVariant}, Dark={StaticResource TextSecondaryDark}}"
                               Opacity="0.7"
                               HorizontalOptions="Fill" />
                    </VerticalStackLayout>

                    <!-- HERO BALANCE CARD (Glassmorphism + Gradient) -->
                    <Border Style="{StaticResource HeroCardGlass}"
                            IsVisible="{Binding Statistics, Converter={StaticResource IsNotNullConverter}}">
                        <Grid RowDefinitions="Auto,Auto,Auto,Auto" RowSpacing="8">
                            <!-- Balance Label -->
                            <Label Grid.Row="0"
                                   Text="SALDO TOTALE"
                                   Style="{StaticResource StatsLabel}" />

                            <!-- Balance Amount (HERO SIZE) -->
                            <Label Grid.Row="1"
                                   Style="{StaticResource HeroBalanceAmount}">
                                <Label.Text>
                                    <MultiBinding Converter="{StaticResource VisibilityValueConverter}">
                                        <Binding Path="Statistics.FormattedTotalBalance" />
                                        <Binding Path="ValuesVisible" />
                                    </MultiBinding>
                                </Label.Text>
                            </Label>

                            <!-- Period Info -->
                            <HorizontalStackLayout Grid.Row="2" Spacing="8">
                                <Label Text="ðŸ“…" FontSize="14" TextColor="White" Opacity="0.8" />
                                <Label Text="{Binding CurrentSalaryMonth}"
                                       Style="{StaticResource PeriodLabel}" />
                            </HorizontalStackLayout>

                            <!-- Period Dates -->
                            <Label Grid.Row="3"
                                   Style="{StaticResource PeriodLabel}"
                                   Opacity="0.6">
                                <Label.Text>
                                    <MultiBinding StringFormat="{}{0:dd MMM yyyy} - {1:dd MMM yyyy}">
                                        <Binding Path="Statistics.PeriodStart" />
                                        <Binding Path="Statistics.PeriodEnd" />
                                    </MultiBinding>
                                </Label.Text>
                            </Label>
                        </Grid>
                    </Border>

                    <!-- STATS GRID (Glassmorphism Cards with Gradients) -->
                    <Grid ColumnDefinitions="*,*"
                          RowDefinitions="Auto,Auto"
                          ColumnSpacing="12"
                          RowSpacing="12"
                          IsVisible="{Binding Statistics, Converter={StaticResource IsNotNullConverter}}">

                        <!-- INCOME CARD (Green Gradient) -->
                        <Border Grid.Row="0" Grid.Column="0"
                                Style="{StaticResource IncomeGlassCard}">
                            <Grid RowDefinitions="Auto,Auto" RowSpacing="6">
                                <Label Grid.Row="0"
                                       Text="ENTRATE"
                                       Style="{StaticResource StatsLabel}" />
                                <Label Grid.Row="1"
                                       Style="{StaticResource StatsAmount}">
                                    <Label.Text>
                                        <MultiBinding Converter="{StaticResource VisibilityValueConverter}">
                                            <Binding Path="Statistics.FormattedIncome" />
                                            <Binding Path="ValuesVisible" />
                                        </MultiBinding>
                                    </Label.Text>
                                </Label>
                            </Grid>
                        </Border>

                        <!-- EXPENSE CARD (Red Gradient) -->
                        <Border Grid.Row="0" Grid.Column="1"
                                Style="{StaticResource ExpenseGlassCard}">
                            <Grid RowDefinitions="Auto,Auto" RowSpacing="6">
                                <Label Grid.Row="0"
                                       Text="USCITE"
                                       Style="{StaticResource StatsLabel}" />
                                <Label Grid.Row="1"
                                       Style="{StaticResource StatsAmount}">
                                    <Label.Text>
                                        <MultiBinding Converter="{StaticResource VisibilityValueConverter}">
                                            <Binding Path="Statistics.FormattedExpenses" />
                                            <Binding Path="ValuesVisible" />
                                        </MultiBinding>
                                    </Label.Text>
                                </Label>
                            </Grid>
                        </Border>

                        <!-- SAVINGS CARD (Blue Gradient) -->
                        <Border Grid.Row="1" Grid.Column="0"
                                Style="{StaticResource SavingsGlassCard}">
                            <Grid RowDefinitions="Auto,Auto" RowSpacing="6">
                                <Label Grid.Row="0"
                                       Text="RISPARMIO"
                                       Style="{StaticResource StatsLabel}" />
                                <Label Grid.Row="1"
                                       Style="{StaticResource StatsAmount}">
                                    <Label.Text>
                                        <MultiBinding Converter="{StaticResource VisibilityValueConverter}">
                                            <Binding Path="Statistics.FormattedSavings" />
                                            <Binding Path="ValuesVisible" />
                                        </MultiBinding>
                                    </Label.Text>
                                </Label>
                            </Grid>
                        </Border>

                        <!-- TRANSACTION COUNT CARD (Neutral Glassmorphism) -->
                        <Border Grid.Row="1" Grid.Column="1"
                                Style="{StaticResource NeutralGlassCard}">
                            <Grid RowDefinitions="Auto,Auto" RowSpacing="6">
                                <Label Grid.Row="0"
                                       Text="MOVIMENTI"
                                       Style="{StaticResource StatsLabel}"
                                       TextColor="{AppThemeBinding Light={StaticResource OnSurface}, Dark={StaticResource TextPrimaryDark}}"
                                       Opacity="0.7" />
                                <Label Grid.Row="1"
                                       Text="{Binding Statistics.TransactionCount}"
                                       Style="{StaticResource StatsAmount}"
                                       TextColor="{AppThemeBinding Light={StaticResource OnSurface}, Dark={StaticResource TextPrimaryDark}}" />
                            </Grid>
                        </Border>

                    </Grid>

                    <!-- RECENT TRANSACTIONS SECTION -->
                    <VerticalStackLayout Spacing="12" Margin="0,8,0,0">
                        <!-- Section Header -->
                        <Grid ColumnDefinitions="*,Auto">
                            <Label Grid.Column="0"
                                   Text="Transazioni Recenti"
                                   Style="{StaticResource TitleMedium}"
                                   TextColor="{AppThemeBinding Light={StaticResource OnSurface}, Dark={StaticResource TextPrimaryDark}}" />
                            <Label Grid.Column="1"
                                   Text="Vedi Tutte â€º"
                                   Style="{StaticResource LabelMedium}"
                                   TextColor="{StaticResource Primary}"
                                   VerticalOptions="Center">
                                <Label.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding NavigateToTransactionsCommand}" />
                                </Label.GestureRecognizers>
                            </Label>
                        </Grid>

                        <!-- Transactions List (Modern Cards) -->
                        <CollectionView ItemsSource="{Binding RecentTransactions}"
                                        EmptyView="Nessuna transazione recente">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:Transaction">
                                    <Border Style="{StaticResource TransactionCardModern}">
                                        <Grid ColumnDefinitions="4,*,Auto"
                                              ColumnSpacing="12">

                                            <!-- Minimal Indicator (Vertical Bar) -->
                                            <BoxView Grid.Column="0"
                                                     WidthRequest="4"
                                                     HeightRequest="48"
                                                     CornerRadius="2"
                                                     VerticalOptions="Center"
                                                     Color="{Binding IsIncome, Converter={StaticResource IncomeToColorConverter}}" />

                                            <!-- Description & Date -->
                                            <VerticalStackLayout Grid.Column="1"
                                                               Spacing="3"
                                                               VerticalOptions="Center">
                                                <Label Text="{Binding Descrizione}"
                                                       Style="{StaticResource BodyLarge}"
                                                       FontAttributes="Bold"
                                                       LineBreakMode="TailTruncation"
                                                       MaxLines="1" />
                                                <Label Text="{Binding Data, StringFormat='{0:dd MMM yyyy}'}"
                                                       Style="{StaticResource BodySmall}"
                                                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />
                                            </VerticalStackLayout>

                                            <!-- Amount -->
                                            <Label Grid.Column="2"
                                                   Text="{Binding FormattedAmount}"
                                                   Style="{StaticResource TitleMedium}"
                                                   FontAttributes="Bold"
                                                   VerticalOptions="Center"
                                                   HorizontalOptions="End">
                                                <Label.TextColor>
                                                    <Binding Path="IsIncome"
                                                             Converter="{StaticResource IncomeToColorConverter}" />
                                                </Label.TextColor>
                                            </Label>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>

                        <!-- View All Button (Outlined) -->
                        <Border StrokeShape="RoundRectangle 24"
                                BackgroundColor="Transparent"
                                Stroke="{StaticResource Primary}"
                                StrokeThickness="1.5"
                                Padding="20,12"
                                Margin="0,8,0,20">
                            <Label Text="Vedi Tutte le Transazioni"
                                   Style="{StaticResource LabelLarge}"
                                   TextColor="{StaticResource Primary}"
                                   HorizontalOptions="Center">
                                <Label.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding NavigateToTransactionsCommand}" />
                                </Label.GestureRecognizers>
                            </Label>
                        </Border>

                    </VerticalStackLayout>

                </VerticalStackLayout>
            </ScrollView>
        </RefreshView>

        <!-- Loading Indicator (Overlay) -->
        <Border IsVisible="{Binding IsLoading}"
                BackgroundColor="#80000000"
                VerticalOptions="Fill"
                HorizontalOptions="Fill">
            <ActivityIndicator IsRunning="{Binding IsLoading}"
                              Color="White"
                              VerticalOptions="Center"
                              HorizontalOptions="Center" />
        </Border>

        <!-- MENU BOTTOM SHEET OVERLAY -->
        <Grid IsVisible="{Binding IsMenuVisible}"
              BackgroundColor="#80000000"
              VerticalOptions="Fill"
              HorizontalOptions="Fill">
            <Grid.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding CloseMenuCommand}" />
            </Grid.GestureRecognizers>

            <!-- Menu Bottom Sheet -->
            <Border VerticalOptions="End"
                    StrokeShape="RoundRectangle 28,28,0,0"
                    BackgroundColor="{AppThemeBinding Light={StaticResource Surface}, Dark={StaticResource SurfaceDark}}"
                    Padding="0"
                    StrokeThickness="0">
                <Border.Shadow>
                    <Shadow Brush="Black" Opacity="0.20" Offset="0,-4" Radius="20" />
                </Border.Shadow>

                <VerticalStackLayout Spacing="0">
                    <!-- Handle -->
                    <BoxView WidthRequest="40"
                             HeightRequest="4"
                             CornerRadius="2"
                             BackgroundColor="{AppThemeBinding Light={StaticResource OnSurfaceVariant}, Dark={StaticResource OutlineVariant}}"
                             Opacity="0.4"
                             HorizontalOptions="Center"
                             Margin="0,12,0,20" />

                    <!-- Menu Items -->

                    <!-- Toggle Values Visibility -->
                    <Grid ColumnDefinitions="Auto,*,Auto"
                          Padding="24,16"
                          ColumnSpacing="16">
                        <Grid.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding ToggleValuesVisibilityCommand}" />
                        </Grid.GestureRecognizers>

                        <!-- Icon -->
                        <Border Grid.Column="0"
                                StrokeShape="RoundRectangle 12"
                                BackgroundColor="{AppThemeBinding Light={StaticResource PrimaryContainer}, Dark={StaticResource PrimaryDark}}"
                                WidthRequest="48"
                                HeightRequest="48"
                                Padding="12"
                                StrokeThickness="0">
                            <Label Text="ðŸ‘"
                                   FontSize="24"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center" />
                        </Border>

                        <!-- Text -->
                        <VerticalStackLayout Grid.Column="1" Spacing="2" VerticalOptions="Center">
                            <Label Text="Mostra/Nascondi Importi"
                                   Style="{StaticResource BodyLarge}"
                                   FontAttributes="Bold" />
                            <Label Style="{StaticResource BodySmall}"
                                   TextColor="{AppThemeBinding Light={StaticResource OnSurfaceVariant}, Dark={StaticResource TextSecondaryDark}}">
                                <Label.Text>
                                    <Binding Path="ValuesVisible" Converter="{StaticResource BoolToStringConverter}" ConverterParameter="Nascondi importi|Mostra importi" />
                                </Label.Text>
                            </Label>
                        </VerticalStackLayout>

                        <!-- Arrow -->
                        <Label Grid.Column="2"
                               Text="â€º"
                               FontSize="24"
                               TextColor="{AppThemeBinding Light={StaticResource OnSurfaceVariant}, Dark={StaticResource TextSecondaryDark}}"
                               VerticalOptions="Center" />
                    </Grid>

                    <!-- Divider -->
                    <BoxView HeightRequest="1"
                             BackgroundColor="{AppThemeBinding Light={StaticResource OutlineVariant}, Dark={StaticResource Outline}}"
                             Opacity="0.5"
                             Margin="24,0" />

                    <!-- Salary Period -->
                    <Grid ColumnDefinitions="Auto,*,Auto"
                          Padding="24,16"
                          ColumnSpacing="16">
                        <Grid.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding NavigateToSalaryConfigCommand}" />
                        </Grid.GestureRecognizers>

                        <!-- Icon -->
                        <Border Grid.Column="0"
                                StrokeShape="RoundRectangle 12"
                                BackgroundColor="{AppThemeBinding Light={StaticResource SecondaryContainer}, Dark={StaticResource SecondaryDark}}"
                                WidthRequest="48"
                                HeightRequest="48"
                                Padding="12"
                                StrokeThickness="0">
                            <Label Text="ðŸ“…"
                                   FontSize="24"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center" />
                        </Border>

                        <!-- Text -->
                        <VerticalStackLayout Grid.Column="1" Spacing="2" VerticalOptions="Center">
                            <Label Text="Periodo Stipendiale"
                                   Style="{StaticResource BodyLarge}"
                                   FontAttributes="Bold" />
                            <Label Text="Configura il tuo mese stipendiale"
                                   Style="{StaticResource BodySmall}"
                                   TextColor="{AppThemeBinding Light={StaticResource OnSurfaceVariant}, Dark={StaticResource TextSecondaryDark}}" />
                        </VerticalStackLayout>

                        <!-- Arrow -->
                        <Label Grid.Column="2"
                               Text="â€º"
                               FontSize="24"
                               TextColor="{AppThemeBinding Light={StaticResource OnSurfaceVariant}, Dark={StaticResource TextSecondaryDark}}"
                               VerticalOptions="Center" />
                    </Grid>

                    <!-- Divider -->
                    <BoxView HeightRequest="1"
                             BackgroundColor="{AppThemeBinding Light={StaticResource OutlineVariant}, Dark={StaticResource Outline}}"
                             Opacity="0.5"
                             Margin="24,0" />

                    <!-- Account Selection -->
                    <Grid ColumnDefinitions="Auto,*,Auto"
                          Padding="24,16,24,32"
                          ColumnSpacing="16">
                        <Grid.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding NavigateToAccountSelectionCommand}" />
                        </Grid.GestureRecognizers>

                        <!-- Icon -->
                        <Border Grid.Column="0"
                                StrokeShape="RoundRectangle 12"
                                BackgroundColor="{AppThemeBinding Light={StaticResource TertiaryContainer}, Dark={StaticResource Tertiary}}"
                                WidthRequest="48"
                                HeightRequest="48"
                                Padding="12"
                                StrokeThickness="0">
                            <Label Text="ðŸ’³"
                                   FontSize="24"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center" />
                        </Border>

                        <!-- Text -->
                        <VerticalStackLayout Grid.Column="1" Spacing="2" VerticalOptions="Center">
                            <Label Text="Cambia Conto"
                                   Style="{StaticResource BodyLarge}"
                                   FontAttributes="Bold" />
                            <Label Text="{Binding CurrentAccount.Nome}"
                                   Style="{StaticResource BodySmall}"
                                   TextColor="{AppThemeBinding Light={StaticResource OnSurfaceVariant}, Dark={StaticResource TextSecondaryDark}}" />
                        </VerticalStackLayout>

                        <!-- Arrow -->
                        <Label Grid.Column="2"
                               Text="â€º"
                               FontSize="24"
                               TextColor="{AppThemeBinding Light={StaticResource OnSurfaceVariant}, Dark={StaticResource TextSecondaryDark}}"
                               VerticalOptions="Center" />
                    </Grid>
                </VerticalStackLayout>
            </Border>
        </Grid>

        <!-- FLOATING ACTION BUTTON (Menu Icon) -->
        <Grid VerticalOptions="End"
              HorizontalOptions="End"
              Margin="0,0,20,20">
            <Border StrokeShape="RoundRectangle 28"
                    Background="{StaticResource GradientPrimary}"
                    WidthRequest="56"
                    HeightRequest="56"
                    StrokeThickness="0">
                <Border.Shadow>
                    <Shadow Brush="{StaticResource Primary}"
                            Offset="0,6"
                            Radius="16"
                            Opacity="0.4" />
                </Border.Shadow>

                <!-- Menu Icon (Grid/Apps style) -->
                <Grid RowDefinitions="Auto,Auto,Auto"
                      ColumnDefinitions="Auto,Auto,Auto"
                      RowSpacing="4"
                      ColumnSpacing="4"
                      HorizontalOptions="Center"
                      VerticalOptions="Center">

                    <!-- Row 1 -->
                    <BoxView Grid.Row="0" Grid.Column="0" WidthRequest="6" HeightRequest="6" CornerRadius="1.5" Color="White" />
                    <BoxView Grid.Row="0" Grid.Column="1" WidthRequest="6" HeightRequest="6" CornerRadius="1.5" Color="White" />
                    <BoxView Grid.Row="0" Grid.Column="2" WidthRequest="6" HeightRequest="6" CornerRadius="1.5" Color="White" />

                    <!-- Row 2 -->
                    <BoxView Grid.Row="1" Grid.Column="0" WidthRequest="6" HeightRequest="6" CornerRadius="1.5" Color="White" />
                    <BoxView Grid.Row="1" Grid.Column="1" WidthRequest="6" HeightRequest="6" CornerRadius="1.5" Color="White" />
                    <BoxView Grid.Row="1" Grid.Column="2" WidthRequest="6" HeightRequest="6" CornerRadius="1.5" Color="White" />

                    <!-- Row 3 -->
                    <BoxView Grid.Row="2" Grid.Column="0" WidthRequest="6" HeightRequest="6" CornerRadius="1.5" Color="White" />
                    <BoxView Grid.Row="2" Grid.Column="1" WidthRequest="6" HeightRequest="6" CornerRadius="1.5" Color="White" />
                    <BoxView Grid.Row="2" Grid.Column="2" WidthRequest="6" HeightRequest="6" CornerRadius="1.5" Color="White" />
                </Grid>

                <Border.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding ToggleMenuCommand}" />
                </Border.GestureRecognizers>
            </Border>
        </Grid>
    </Grid>

</ContentPage>
