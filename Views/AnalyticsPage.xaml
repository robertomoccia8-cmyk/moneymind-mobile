<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:MoneyMindApp.ViewModels"
             xmlns:models="clr-namespace:MoneyMindApp.Models"
             xmlns:lvc="clr-namespace:LiveChartsCore.SkiaSharpView.Maui;assembly=LiveChartsCore.SkiaSharpView.Maui"
             x:Class="MoneyMindApp.Views.AnalyticsPage"
             x:DataType="viewmodels:AnalyticsViewModel"
             Title="Analisi">

    <RefreshView Command="{Binding RefreshCommand}"
                 IsRefreshing="{Binding IsLoading}"
                 RefreshColor="{StaticResource Primary}">
        <ScrollView>
            <VerticalStackLayout Padding="20,16,20,20" Spacing="20">

                <!-- Header with Year Selector -->
                <VerticalStackLayout Spacing="12">
                    <Label Text="Analisi Finanziaria"
                           FontFamily="PoppinsSemiBold"
                           FontSize="28"
                           TextColor="{StaticResource TextPrimary}" />

                    <Label Text="Visualizza le tue statistiche annuali"
                           FontFamily="PoppinsRegular"
                           FontSize="14"
                           TextColor="{StaticResource TextSecondary}"
                           Opacity="0.9" />

                    <!-- Year Selector Pills -->
                    <ScrollView Orientation="Horizontal" HorizontalScrollBarVisibility="Never">
                        <HorizontalStackLayout BindableLayout.ItemsSource="{Binding AvailableYears}"
                                              Spacing="8"
                                              Padding="0,8">
                            <BindableLayout.ItemTemplate>
                                <DataTemplate x:DataType="x:Int32">
                                    <Border StrokeShape="RoundRectangle 20"
                                            Padding="20,10">
                                        <Border.Triggers>
                                            <DataTrigger TargetType="Border"
                                                        Binding="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:AnalyticsViewModel}}, Path=SelectedYear}"
                                                        Value="{Binding .}">
                                                <Setter Property="BackgroundColor" Value="{StaticResource Primary}" />
                                                <Setter Property="StrokeThickness" Value="0" />
                                            </DataTrigger>
                                        </Border.Triggers>
                                        <Border.Style>
                                            <Style TargetType="Border">
                                                <Setter Property="BackgroundColor" Value="{StaticResource Gray200}" />
                                                <Setter Property="StrokeThickness" Value="0" />
                                            </Style>
                                        </Border.Style>
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnYearTapped" />
                                        </Border.GestureRecognizers>

                                        <Label>
                                            <Label.Triggers>
                                                <DataTrigger TargetType="Label"
                                                            Binding="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:AnalyticsViewModel}}, Path=SelectedYear}"
                                                            Value="{Binding .}">
                                                    <Setter Property="TextColor" Value="White" />
                                                </DataTrigger>
                                            </Label.Triggers>
                                            <Label.Style>
                                                <Style TargetType="Label">
                                                    <Setter Property="Text" Value="{Binding .}" />
                                                    <Setter Property="FontFamily" Value="PoppinsSemiBold" />
                                                    <Setter Property="FontSize" Value="14" />
                                                    <Setter Property="TextColor" Value="{StaticResource TextPrimary}" />
                                                </Style>
                                            </Label.Style>
                                        </Label>
                                    </Border>
                                </DataTemplate>
                            </BindableLayout.ItemTemplate>
                        </HorizontalStackLayout>
                    </ScrollView>
                </VerticalStackLayout>

                <!-- Hero Stats Cards with Gradients -->
                <Grid ColumnDefinitions="*,*,*" ColumnSpacing="12">

                    <!-- Income Card -->
                    <Border Grid.Column="0"
                            StrokeShape="RoundRectangle 20"
                            StrokeThickness="0"
                            Padding="16,18">
                        <Border.Shadow>
                            <Shadow Brush="{StaticResource Income}" Opacity="0.25" Offset="0,4" Radius="12" />
                        </Border.Shadow>
                        <Border.Background>
                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                <GradientStop Color="{StaticResource Income}" Offset="0.0" />
                                <GradientStop Color="{StaticResource IncomeDark}" Offset="1.0" />
                            </LinearGradientBrush>
                        </Border.Background>

                        <VerticalStackLayout Spacing="8">
                            <!-- Icon -->
                            <Border StrokeShape="RoundRectangle 20"
                                    BackgroundColor="#40FFFFFF"
                                    WidthRequest="40"
                                    HeightRequest="40"
                                    HorizontalOptions="Start">
                                <Path Data="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6h-6z"
                                      Fill="White"
                                      Aspect="Uniform"
                                      HeightRequest="20"
                                      WidthRequest="20"
                                      HorizontalOptions="Center"
                                      VerticalOptions="Center" />
                            </Border>

                            <Label Text="Entrate"
                                   FontFamily="PoppinsRegular"
                                   FontSize="11"
                                   TextColor="White"
                                   Opacity="0.9" />

                            <Label Text="{Binding TotalYearIncome, StringFormat='{0:C0}'}"
                                   FontFamily="PoppinsSemiBold"
                                   FontSize="18"
                                   TextColor="White"
                                   LineBreakMode="TailTruncation" />
                        </VerticalStackLayout>
                    </Border>

                    <!-- Expenses Card -->
                    <Border Grid.Column="1"
                            StrokeShape="RoundRectangle 20"
                            StrokeThickness="0"
                            Padding="16,18">
                        <Border.Shadow>
                            <Shadow Brush="{StaticResource Expense}" Opacity="0.25" Offset="0,4" Radius="12" />
                        </Border.Shadow>
                        <Border.Background>
                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                <GradientStop Color="{StaticResource Expense}" Offset="0.0" />
                                <GradientStop Color="{StaticResource ExpenseDark}" Offset="1.0" />
                            </LinearGradientBrush>
                        </Border.Background>

                        <VerticalStackLayout Spacing="8">
                            <!-- Icon -->
                            <Border StrokeShape="RoundRectangle 20"
                                    BackgroundColor="#40FFFFFF"
                                    WidthRequest="40"
                                    HeightRequest="40"
                                    HorizontalOptions="Start">
                                <Path Data="M16 18l2.29-2.29-4.88-4.88-4 4L2 7.41 3.41 6l6 6 4-4 6.3 6.29L22 12v6h-6z"
                                      Fill="White"
                                      Aspect="Uniform"
                                      HeightRequest="20"
                                      WidthRequest="20"
                                      HorizontalOptions="Center"
                                      VerticalOptions="Center" />
                            </Border>

                            <Label Text="Uscite"
                                   FontFamily="PoppinsRegular"
                                   FontSize="11"
                                   TextColor="White"
                                   Opacity="0.9" />

                            <Label Text="{Binding TotalYearExpenses, StringFormat='{0:C0}'}"
                                   FontFamily="PoppinsSemiBold"
                                   FontSize="18"
                                   TextColor="White"
                                   LineBreakMode="TailTruncation" />
                        </VerticalStackLayout>
                    </Border>

                    <!-- Savings Card -->
                    <Border Grid.Column="2"
                            StrokeShape="RoundRectangle 20"
                            StrokeThickness="0"
                            Padding="16,18">
                        <Border.Shadow>
                            <Shadow Brush="{StaticResource Savings}" Opacity="0.25" Offset="0,4" Radius="12" />
                        </Border.Shadow>
                        <Border.Background>
                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                <GradientStop Color="{StaticResource Savings}" Offset="0.0" />
                                <GradientStop Color="{StaticResource SavingsDark}" Offset="1.0" />
                            </LinearGradientBrush>
                        </Border.Background>

                        <VerticalStackLayout Spacing="8">
                            <!-- Icon -->
                            <Border StrokeShape="RoundRectangle 20"
                                    BackgroundColor="#40FFFFFF"
                                    WidthRequest="40"
                                    HeightRequest="40"
                                    HorizontalOptions="Start">
                                <Path Data="M19 14V6c0-1.1-.9-2-2-2H3c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zm-9-1c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm13-6v11c0 1.1-.9 2-2 2H4v-2h17V7h2z"
                                      Fill="White"
                                      Aspect="Uniform"
                                      HeightRequest="20"
                                      WidthRequest="20"
                                      HorizontalOptions="Center"
                                      VerticalOptions="Center" />
                            </Border>

                            <Label Text="Risparmio"
                                   FontFamily="PoppinsRegular"
                                   FontSize="11"
                                   TextColor="White"
                                   Opacity="0.9" />

                            <Label Text="{Binding TotalYearSavings, StringFormat='{0:C0}'}"
                                   FontFamily="PoppinsSemiBold"
                                   FontSize="18"
                                   TextColor="White"
                                   LineBreakMode="TailTruncation" />
                        </VerticalStackLayout>
                    </Border>
                </Grid>

                <!-- Quick Insights Row -->
                <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                    <Border Grid.Column="0"
                            StrokeShape="RoundRectangle 16"
                            StrokeThickness="0"
                            Padding="16"
                            BackgroundColor="{StaticResource IncomeBackground}">
                        <VerticalStackLayout Spacing="6">
                            <HorizontalStackLayout Spacing="8">
                                <Path Data="M12 2L1 21h22L12 2zm0 3.99L19.53 19H4.47L12 5.99zM11 16h2v2h-2zm0-6h2v4h-2z"
                                      Fill="{StaticResource IncomeDark}"
                                      Aspect="Uniform"
                                      HeightRequest="16"
                                      WidthRequest="16"
                                      VerticalOptions="Center" />
                                <Label Text="Mese Migliore"
                                       FontFamily="PoppinsRegular"
                                       FontSize="12"
                                       TextColor="{StaticResource IncomeDark}"
                                       VerticalOptions="Center" />
                            </HorizontalStackLayout>
                            <Label Text="{Binding HighestIncomeMonth}"
                                   FontFamily="PoppinsSemiBold"
                                   FontSize="14"
                                   TextColor="{StaticResource IncomeDark}"
                                   LineBreakMode="TailTruncation" />
                        </VerticalStackLayout>
                    </Border>

                    <Border Grid.Column="1"
                            StrokeShape="RoundRectangle 16"
                            StrokeThickness="0"
                            Padding="16"
                            BackgroundColor="{StaticResource ExpenseBackground}">
                        <VerticalStackLayout Spacing="6">
                            <HorizontalStackLayout Spacing="8">
                                <Path Data="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"
                                      Fill="{StaticResource ExpenseDark}"
                                      Aspect="Uniform"
                                      HeightRequest="16"
                                      WidthRequest="16"
                                      VerticalOptions="Center" />
                                <Label Text="Mese Critico"
                                       FontFamily="PoppinsRegular"
                                       FontSize="12"
                                       TextColor="{StaticResource ExpenseDark}"
                                       VerticalOptions="Center" />
                            </HorizontalStackLayout>
                            <Label Text="{Binding HighestExpenseMonth}"
                                   FontFamily="PoppinsSemiBold"
                                   FontSize="14"
                                   TextColor="{StaticResource ExpenseDark}"
                                   LineBreakMode="TailTruncation" />
                        </VerticalStackLayout>
                    </Border>
                </Grid>

                <!-- Income Chart Card -->
                <Border StrokeShape="RoundRectangle 20"
                        StrokeThickness="0"
                        Padding="20"
                        BackgroundColor="White">
                    <Border.Shadow>
                        <Shadow Brush="Black" Opacity="0.08" Offset="0,2" Radius="8" />
                    </Border.Shadow>

                    <VerticalStackLayout Spacing="16">
                        <HorizontalStackLayout Spacing="12">
                            <Border StrokeShape="RoundRectangle 12"
                                    BackgroundColor="{StaticResource IncomeBackground}"
                                    Padding="12"
                                    VerticalOptions="Start">
                                <Path Data="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6h-6z"
                                      Fill="{StaticResource Income}"
                                      Aspect="Uniform"
                                      HeightRequest="20"
                                      WidthRequest="20" />
                            </Border>
                            <VerticalStackLayout Spacing="2" VerticalOptions="Center">
                                <Label Text="Entrate Mensili"
                                       FontFamily="PoppinsSemiBold"
                                       FontSize="18"
                                       TextColor="{StaticResource TextPrimary}" />
                                <Label Text="Andamento delle entrate per ogni mese"
                                       FontFamily="PoppinsRegular"
                                       FontSize="12"
                                       TextColor="{StaticResource TextSecondary}"
                                       Opacity="0.8" />
                            </VerticalStackLayout>
                        </HorizontalStackLayout>

                        <lvc:CartesianChart Series="{Binding IncomeSeries}"
                                            XAxes="{Binding XAxes}"
                                            YAxes="{Binding YAxes}"
                                            HeightRequest="250" />
                    </VerticalStackLayout>
                </Border>

                <!-- Expenses Chart Card -->
                <Border StrokeShape="RoundRectangle 20"
                        StrokeThickness="0"
                        Padding="20"
                        BackgroundColor="White">
                    <Border.Shadow>
                        <Shadow Brush="Black" Opacity="0.08" Offset="0,2" Radius="8" />
                    </Border.Shadow>

                    <VerticalStackLayout Spacing="16">
                        <HorizontalStackLayout Spacing="12">
                            <Border StrokeShape="RoundRectangle 12"
                                    BackgroundColor="{StaticResource ExpenseBackground}"
                                    Padding="12"
                                    VerticalOptions="Start">
                                <Path Data="M16 18l2.29-2.29-4.88-4.88-4 4L2 7.41 3.41 6l6 6 4-4 6.3 6.29L22 12v6h-6z"
                                      Fill="{StaticResource Expense}"
                                      Aspect="Uniform"
                                      HeightRequest="20"
                                      WidthRequest="20" />
                            </Border>
                            <VerticalStackLayout Spacing="2" VerticalOptions="Center">
                                <Label Text="Uscite Mensili"
                                       FontFamily="PoppinsSemiBold"
                                       FontSize="18"
                                       TextColor="{StaticResource TextPrimary}" />
                                <Label Text="Monitoraggio delle spese mensili"
                                       FontFamily="PoppinsRegular"
                                       FontSize="12"
                                       TextColor="{StaticResource TextSecondary}"
                                       Opacity="0.8" />
                            </VerticalStackLayout>
                        </HorizontalStackLayout>

                        <lvc:CartesianChart Series="{Binding ExpenseSeries}"
                                            XAxes="{Binding XAxes}"
                                            YAxes="{Binding YAxes}"
                                            HeightRequest="250" />
                    </VerticalStackLayout>
                </Border>

                <!-- Savings Analysis Card -->
                <Border StrokeShape="RoundRectangle 20"
                        StrokeThickness="0"
                        Padding="20"
                        BackgroundColor="White">
                    <Border.Shadow>
                        <Shadow Brush="Black" Opacity="0.08" Offset="0,2" Radius="8" />
                    </Border.Shadow>

                    <VerticalStackLayout Spacing="16">
                        <HorizontalStackLayout Spacing="12">
                            <Border StrokeShape="RoundRectangle 12"
                                    BackgroundColor="{StaticResource SavingsBackground}"
                                    Padding="12"
                                    VerticalOptions="Start">
                                <Path Data="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"
                                      Fill="{StaticResource Savings}"
                                      Aspect="Uniform"
                                      HeightRequest="20"
                                      WidthRequest="20" />
                            </Border>
                            <VerticalStackLayout Spacing="2" VerticalOptions="Center">
                                <Label Text="Analisi Risparmi"
                                       FontFamily="PoppinsSemiBold"
                                       FontSize="18"
                                       TextColor="{StaticResource TextPrimary}" />
                                <Label Text="Panoramica completa dei tuoi risparmi"
                                       FontFamily="PoppinsRegular"
                                       FontSize="12"
                                       TextColor="{StaticResource TextSecondary}"
                                       Opacity="0.8" />
                            </VerticalStackLayout>
                        </HorizontalStackLayout>

                        <!-- Savings Stats -->
                        <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*,*" RowSpacing="12" ColumnSpacing="12">
                            <Border Grid.Row="0" Grid.Column="0"
                                    StrokeShape="RoundRectangle 12"
                                    BackgroundColor="{StaticResource SavingsBackground}"
                                    Padding="14">
                                <VerticalStackLayout Spacing="4">
                                    <Label Text="Media Mensile"
                                           FontFamily="PoppinsRegular"
                                           FontSize="11"
                                           TextColor="{StaticResource Gray600}" />
                                    <Label Text="{Binding AverageMonthlySavings, StringFormat='{0:C2}'}"
                                           FontFamily="PoppinsSemiBold"
                                           FontSize="16"
                                           TextColor="{StaticResource SavingsDark}" />
                                </VerticalStackLayout>
                            </Border>

                            <Border Grid.Row="0" Grid.Column="1"
                                    StrokeShape="RoundRectangle 12"
                                    BackgroundColor="{StaticResource IncomeBackground}"
                                    Padding="14">
                                <VerticalStackLayout Spacing="4">
                                    <Label Text="Mesi Positivi"
                                           FontFamily="PoppinsRegular"
                                           FontSize="11"
                                           TextColor="{StaticResource Gray600}" />
                                    <Label Text="{Binding PositiveMonthsCount}"
                                           FontFamily="PoppinsSemiBold"
                                           FontSize="16"
                                           TextColor="{StaticResource IncomeDark}" />
                                </VerticalStackLayout>
                            </Border>

                            <Border Grid.Row="1" Grid.Column="0"
                                    StrokeShape="RoundRectangle 12"
                                    BackgroundColor="{StaticResource IncomeBackground}"
                                    Padding="14">
                                <VerticalStackLayout Spacing="4">
                                    <Label Text="Miglior Mese"
                                           FontFamily="PoppinsRegular"
                                           FontSize="11"
                                           TextColor="{StaticResource Gray600}" />
                                    <Label Text="{Binding BestSavingsMonth}"
                                           FontFamily="PoppinsSemiBold"
                                           FontSize="12"
                                           TextColor="{StaticResource IncomeDark}"
                                           LineBreakMode="TailTruncation" />
                                </VerticalStackLayout>
                            </Border>

                            <Border Grid.Row="1" Grid.Column="1"
                                    StrokeShape="RoundRectangle 12"
                                    BackgroundColor="{StaticResource ExpenseBackground}"
                                    Padding="14">
                                <VerticalStackLayout Spacing="4">
                                    <Label Text="Peggior Mese"
                                           FontFamily="PoppinsRegular"
                                           FontSize="11"
                                           TextColor="{StaticResource Gray600}" />
                                    <Label Text="{Binding WorstSavingsMonth}"
                                           FontFamily="PoppinsSemiBold"
                                           FontSize="12"
                                           TextColor="{StaticResource ExpenseDark}"
                                           LineBreakMode="TailTruncation" />
                                </VerticalStackLayout>
                            </Border>
                        </Grid>
                    </VerticalStackLayout>
                </Border>

                <!-- Savings Bar Chart -->
                <Border StrokeShape="RoundRectangle 20"
                        StrokeThickness="0"
                        Padding="20"
                        BackgroundColor="White">
                    <Border.Shadow>
                        <Shadow Brush="Black" Opacity="0.08" Offset="0,2" Radius="8" />
                    </Border.Shadow>

                    <VerticalStackLayout Spacing="16">
                        <HorizontalStackLayout Spacing="12">
                            <Border StrokeShape="RoundRectangle 12"
                                    BackgroundColor="{StaticResource SavingsBackground}"
                                    Padding="12"
                                    VerticalOptions="Start">
                                <Path Data="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"
                                      Fill="{StaticResource Savings}"
                                      Aspect="Uniform"
                                      HeightRequest="20"
                                      WidthRequest="20" />
                            </Border>
                            <VerticalStackLayout Spacing="2" VerticalOptions="Center">
                                <Label Text="Risparmio Mensile"
                                       FontFamily="PoppinsSemiBold"
                                       FontSize="18"
                                       TextColor="{StaticResource TextPrimary}" />
                                <Label Text="Verde = risparmio â€¢ Rosso = perdita"
                                       FontFamily="PoppinsRegular"
                                       FontSize="12"
                                       TextColor="{StaticResource TextSecondary}"
                                       Opacity="0.8" />
                            </VerticalStackLayout>
                        </HorizontalStackLayout>

                        <lvc:CartesianChart Series="{Binding SavingsBarSeries}"
                                            XAxes="{Binding XAxes}"
                                            YAxes="{Binding YAxes}"
                                            HeightRequest="250" />
                    </VerticalStackLayout>
                </Border>

                <!-- Cumulative Savings Chart -->
                <Border StrokeShape="RoundRectangle 20"
                        StrokeThickness="0"
                        Padding="20"
                        BackgroundColor="White">
                    <Border.Shadow>
                        <Shadow Brush="Black" Opacity="0.08" Offset="0,2" Radius="8" />
                    </Border.Shadow>

                    <VerticalStackLayout Spacing="16">
                        <HorizontalStackLayout Spacing="12">
                            <Border StrokeShape="RoundRectangle 12"
                                    BackgroundColor="{StaticResource SavingsBackground}"
                                    Padding="12"
                                    VerticalOptions="Start">
                                <Path Data="M23 8c0 1.1-.9 2-2 2-.18 0-.35-.02-.51-.07l-3.56 3.55c.05.16.07.34.07.52 0 1.1-.9 2-2 2s-2-.9-2-2c0-.18.02-.36.07-.52l-2.55-2.55c-.16.05-.34.07-.52.07s-.36-.02-.52-.07l-4.55 4.56c.05.16.07.33.07.51 0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2c.18 0 .35.02.51.07l4.56-4.55C8.02 9.36 8 9.18 8 9c0-1.1.9-2 2-2s2 .9 2 2c0 .18-.02.36-.07.52l2.55 2.55c.16-.05.34-.07.52-.07s.36.02.52.07l3.55-3.56C19.02 8.35 19 8.18 19 8c0-1.1.9-2 2-2s2 .9 2 2z"
                                      Fill="{StaticResource Savings}"
                                      Aspect="Uniform"
                                      HeightRequest="20"
                                      WidthRequest="20" />
                            </Border>
                            <VerticalStackLayout Spacing="2" VerticalOptions="Center">
                                <Label Text="Risparmio Cumulativo"
                                       FontFamily="PoppinsSemiBold"
                                       FontSize="18"
                                       TextColor="{StaticResource TextPrimary}" />
                                <Label Text="Andamento progressivo del risparmio totale"
                                       FontFamily="PoppinsRegular"
                                       FontSize="12"
                                       TextColor="{StaticResource TextSecondary}"
                                       Opacity="0.8" />
                            </VerticalStackLayout>
                        </HorizontalStackLayout>

                        <lvc:CartesianChart Series="{Binding SavingsCumulativeSeries}"
                                            XAxes="{Binding XAxes}"
                                            YAxes="{Binding YAxes}"
                                            HeightRequest="250" />
                    </VerticalStackLayout>
                </Border>

                <!-- Monthly Details Table -->
                <Border StrokeShape="RoundRectangle 20"
                        StrokeThickness="0"
                        Padding="20"
                        BackgroundColor="White">
                    <Border.Shadow>
                        <Shadow Brush="Black" Opacity="0.08" Offset="0,2" Radius="8" />
                    </Border.Shadow>

                    <VerticalStackLayout Spacing="16">
                        <HorizontalStackLayout Spacing="12">
                            <Border StrokeShape="RoundRectangle 12"
                                    BackgroundColor="{StaticResource Gray100}"
                                    Padding="12"
                                    VerticalOptions="Start">
                                <Path Data="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"
                                      Fill="{StaticResource Gray700}"
                                      Aspect="Uniform"
                                      HeightRequest="20"
                                      WidthRequest="20" />
                            </Border>
                            <VerticalStackLayout Spacing="2" VerticalOptions="Center">
                                <Label Text="Dettaglio Mensile"
                                       FontFamily="PoppinsSemiBold"
                                       FontSize="18"
                                       TextColor="{StaticResource TextPrimary}" />
                                <Label Text="Visualizza i dati mese per mese"
                                       FontFamily="PoppinsRegular"
                                       FontSize="12"
                                       TextColor="{StaticResource TextSecondary}"
                                       Opacity="0.8" />
                            </VerticalStackLayout>
                        </HorizontalStackLayout>

                        <CollectionView ItemsSource="{Binding MonthlyStats}">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:MonthlyStats">
                                    <Border StrokeShape="RoundRectangle 12"
                                            StrokeThickness="1"
                                            Stroke="{StaticResource Gray200}"
                                            BackgroundColor="{StaticResource Gray50}"
                                            Padding="16"
                                            Margin="0,0,0,8">
                                        <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*,Auto" RowSpacing="8">
                                            <!-- Month Name -->
                                            <Label Grid.Row="0" Grid.Column="0"
                                                   Text="{Binding MonthName}"
                                                   FontFamily="PoppinsSemiBold"
                                                   FontSize="15"
                                                   TextColor="{StaticResource TextPrimary}"
                                                   VerticalOptions="Center" />

                                            <!-- Savings Amount -->
                                            <Label Grid.Row="0" Grid.Column="1"
                                                   Text="{Binding FormattedSavings}"
                                                   FontFamily="PoppinsSemiBold"
                                                   FontSize="15"
                                                   VerticalOptions="Center"
                                                   HorizontalOptions="End">
                                                <Label.Triggers>
                                                    <DataTrigger TargetType="Label"
                                                                Binding="{Binding IsSavingsPositive}"
                                                                Value="True">
                                                        <Setter Property="TextColor" Value="{StaticResource Income}" />
                                                    </DataTrigger>
                                                    <DataTrigger TargetType="Label"
                                                                Binding="{Binding IsSavingsPositive}"
                                                                Value="False">
                                                        <Setter Property="TextColor" Value="{StaticResource Expense}" />
                                                    </DataTrigger>
                                                </Label.Triggers>
                                            </Label>

                                            <!-- Period Range -->
                                            <Label Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                                                   Text="{Binding FormattedPeriod}"
                                                   FontFamily="PoppinsRegular"
                                                   FontSize="12"
                                                   TextColor="{StaticResource TextSecondary}"
                                                   Opacity="0.8"
                                                   VerticalOptions="Center" />
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </Border>

                <!-- Loading Indicator -->
                <ActivityIndicator IsRunning="{Binding IsLoading}"
                                  IsVisible="{Binding IsLoading}"
                                  Color="{StaticResource Primary}"
                                  HeightRequest="50"
                                  VerticalOptions="Center" />

            </VerticalStackLayout>
        </ScrollView>
    </RefreshView>
</ContentPage>
