<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:MoneyMindApp.ViewModels"
             xmlns:models="clr-namespace:MoneyMindApp.Models"
             x:Class="MoneyMindApp.Views.ImportHeaderSelectionPage"
             x:DataType="viewmodels:ImportHeaderSelectionViewModel"
             Title="Importa - Selezione Header"
             Shell.NavBarIsVisible="True">

    <ScrollView>
        <VerticalStackLayout Padding="16" Spacing="20">

            <!-- Header -->
            <Frame BackgroundColor="{StaticResource Primary}" Padding="16" CornerRadius="12">
                <VerticalStackLayout Spacing="8">
                    <Label Text="ðŸ“„ Step 2: Seleziona File e Riga Header"
                           FontSize="20"
                           FontAttributes="Bold"
                           TextColor="White"/>
                    <Label Text="Scegli il file da importare e indica quale riga contiene le intestazioni delle colonne."
                           FontSize="14"
                           TextColor="White"
                           Opacity="0.9"/>
                </VerticalStackLayout>
            </Frame>

            <!-- File Selection -->
            <Frame BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray900}}"
                   Padding="16" CornerRadius="12">
                <VerticalStackLayout Spacing="12">
                    <Label Text="ðŸ“ Selezione File" FontSize="18" FontAttributes="Bold"/>

                    <Button Text="ðŸ“‚ Scegli File CSV/Excel"
                            Command="{Binding SelectFileCommand}"
                            BackgroundColor="{StaticResource Primary}"
                            TextColor="White"/>

                    <Label Text="{Binding SelectedFileName}"
                           IsVisible="{Binding IsFileSelected}"
                           FontSize="14"
                           FontAttributes="Bold"
                           TextColor="{StaticResource Primary}"/>
                </VerticalStackLayout>
            </Frame>

            <!-- File Preview -->
            <Frame BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray900}}"
                   Padding="16" CornerRadius="12"
                   IsVisible="{Binding IsFileSelected}">
                <VerticalStackLayout Spacing="12">
                    <Label Text="ðŸ‘ï¸ Anteprima Prime Righe" FontSize="18" FontAttributes="Bold"/>
                    <Label Text="Clicca sulla riga che contiene le intestazioni:"
                           FontSize="14"
                           TextColor="Gray"/>

                    <CollectionView ItemsSource="{Binding FilePreviewRows}"
                                    SelectionMode="None"
                                    HeightRequest="400">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:FilePreviewRow">
                                <Border Padding="12"
                                        Margin="0,4"
                                        StrokeThickness="2"
                                        StrokeShape="RoundRectangle 8">
                                    <Border.Triggers>
                                        <DataTrigger TargetType="Border" Binding="{Binding IsSelected}" Value="True">
                                            <Setter Property="BackgroundColor" Value="#2196F3" />
                                            <Setter Property="Stroke" Value="#1565C0" />
                                        </DataTrigger>
                                        <DataTrigger TargetType="Border" Binding="{Binding IsSelected}" Value="False">
                                            <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=#F5F5F5, Dark=#2D2D2D}" />
                                            <Setter Property="Stroke" Value="{AppThemeBinding Light=#E0E0E0, Dark=#404040}" />
                                        </DataTrigger>
                                    </Border.Triggers>

                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:ImportHeaderSelectionViewModel}}, Path=SelectPreviewRowCommand}"
                                            CommandParameter="{Binding .}"/>
                                    </Border.GestureRecognizers>

                                    <Grid ColumnDefinitions="60,*" ColumnSpacing="12">
                                        <!-- Row Number -->
                                        <Label Text="{Binding RowNumberFormatted}"
                                               FontFamily="Monospace"
                                               FontSize="14"
                                               FontAttributes="Bold"
                                               VerticalOptions="Center"
                                               HorizontalTextAlignment="Center"
                                               TextColor="{Binding IsSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='White|#666666'}"/>

                                        <!-- Content -->
                                        <Label Grid.Column="1"
                                               Text="{Binding ContentTruncated}"
                                               FontFamily="Monospace"
                                               FontSize="12"
                                               LineBreakMode="TailTruncation"
                                               VerticalOptions="Center"
                                               TextColor="{Binding IsSelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter='White|Black'}"/>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
            </Frame>

            <!-- Header Row Configuration -->
            <Frame BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray900}}"
                   Padding="16" CornerRadius="12"
                   IsVisible="{Binding IsFileSelected}">
                <VerticalStackLayout Spacing="12">
                    <Label Text="âš™ï¸ Configurazione Header" FontSize="18" FontAttributes="Bold"/>

                    <Grid ColumnDefinitions="*,120" ColumnSpacing="12" RowSpacing="12">
                        <!-- Header Row Number -->
                        <VerticalStackLayout Grid.Column="0" Spacing="4">
                            <Label Text="Numero Riga Intestazione" FontSize="14"/>
                            <Entry Text="{Binding HeaderRowNumber}"
                                   Keyboard="Numeric"
                                   Placeholder="Es. 10"
                                   FontSize="16"
                                   HorizontalTextAlignment="Center"/>
                        </VerticalStackLayout>

                        <!-- Has Headers Checkbox -->
                        <VerticalStackLayout Grid.Column="1" Spacing="4">
                            <Label Text="Ha intestazioni" FontSize="14"/>
                            <HorizontalStackLayout Spacing="8" HorizontalOptions="Center" Margin="0,8,0,0">
                                <CheckBox IsChecked="{Binding HasHeaders}"/>
                                <Label Text="SÃ¬" VerticalOptions="Center"/>
                            </HorizontalStackLayout>
                        </VerticalStackLayout>
                    </Grid>

                    <Label>
                        <Label.FormattedText>
                            <FormattedString>
                                <Span Text="ðŸ’¡ Suggerimento: " FontAttributes="Bold"/>
                                <Span Text="Se il file ha loghi o informazioni nelle prime righe, indica il numero della riga dove iniziano i nomi delle colonne (es. Data, Importo, Descrizione)."/>
                            </FormattedString>
                        </Label.FormattedText>
                    </Label>
                </VerticalStackLayout>
            </Frame>

            <!-- Status Message -->
            <Label Text="{Binding StatusMessage}"
                   FontSize="14"
                   HorizontalTextAlignment="Center"
                   TextColor="{StaticResource Primary}"
                   IsVisible="{Binding StatusMessage, Converter={StaticResource StringToBoolConverter}}"/>

            <!-- Loading Indicator -->
            <ActivityIndicator IsRunning="{Binding IsLoading}"
                               IsVisible="{Binding IsLoading}"
                               Color="{StaticResource Primary}"/>

            <!-- Navigation Buttons -->
            <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                <Button Grid.Column="0"
                        Text="â¬…ï¸ Indietro"
                        Command="{Binding BackCommand}"
                        BackgroundColor="Gray"
                        TextColor="White"/>

                <Button Grid.Column="1"
                        Text="Avanti âž¡ï¸"
                        Command="{Binding ProceedToMappingCommand}"
                        IsEnabled="{Binding CanProceed}"
                        BackgroundColor="{StaticResource Primary}"
                        TextColor="White"/>
            </Grid>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
